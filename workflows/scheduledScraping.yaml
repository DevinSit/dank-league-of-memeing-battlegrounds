main:
  steps:
    - scrapePosts:
        call: http.get
        args:
          url: https://us-central1-serverless-hackathon-devin.cloudfunctions.net/scrapePosts
        result: postsResult

    - extractImageUrls:
        steps:
          - createEmptyList:
              assign:
                - imageUrls: []

          - loopPosts:
              for:
                  value: post
                  in: ${postsResult.body.posts}
                  steps:
                    - extractImageUrl:
                        assign:
                          - imageUrls: ${list.concat(imageUrls, post.url)}

    - ingestImages:
        call: http.post
        args:
          url: https://us-central1-serverless-hackathon-devin.cloudfunctions.net/ingestImages
          body:
            imageUrls: ${imageUrls}
        result: imagesResult

    - ingestPosts:
        call: http.post
        args:
          url: https://us-central1-serverless-hackathon-devin.cloudfunctions.net/ingestPosts
          body:
            posts: ${postsResult.body.posts}
            urlsToHashes: ${imagesResult.body.urlsToHashes}
        result: postsResult

    - predict:
        call: http.post
        args:
          url: https://us-central1-serverless-hackathon-devin.cloudfunctions.net/predict
          body:
            imageHashes: ${imagesResult.body.imageHashes}
        result: predictionsResult

    - returnResult:
        return: 
          - predictions: ${predictionsResult.body.predictions}
          - posts: ${postsResult.body.posts}